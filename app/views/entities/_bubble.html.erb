<div id="graph"></div>

<script>
	var w = 970, h = 640;
	var graph = d3.select("#graph").append("svg:svg").attr("width", w).attr("height", h);
	
	// Functions
	var scale = d3.scale.linear();
	
	// Bubble Chart	
	var bubble = d3.layout.pack()
		.sort(null)
		.value(function(d) { return (d.amount_raw > 0) ? d.amount_raw / 1000 : 1; })
		.size([w,h]);

	d3.json("<%= request.url %>.json", function(json) {
		var node = graph.selectAll("g.node")
			.data(bubble(bubblize(json.entities))
				.filter(function(d) { return !d.children; }))
		.enter().append("svg:g")
			.attr("class","node")
			.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
			
		node.append("svg:circle")
			.attr("r", function(d) { return d.r; })
			.style("fill", function(d) { return d3.interpolateRgb("#963", "#6f6")(d.data.percent_clean/100); })
			.on("click", function(d) { location.href = d.data.entity_url; });


//		node.append("svg:text")
//			.text(function(d) { return d.data.amount_raw; });
			
	});
	
	function bubblize( data ) {
		var bubbles = [];
		
		for (var b in data) {
			var bubble = data[b];
			bubbles.push(bubble);
		}
		//console.log(bubbles);
		return {children: bubbles};
	}
	
</script>

<style>
	#graph circle {stroke:#fff; stroke-width:2;opacity:0.8;}
		#graph circle:hover {opacity:1; cursor: pointer;}

		#graph circle {fill:#963;}
		#graph circle.Clean {fill:#0f0;}
	#graph text {fill:#ccc; font-size:18px;}
		#graph text.label {fill:#111; display:block; opacity:0;}
		#graph text.label:hover {opacity:1; cursor:pointer;}
	#graph line {stroke:#630;}
</style>